feed_uri: http://assets.axoom.cloud/mixins/axoom-portal-app.xml
name: AXOOM Portal App Mixin
summary: container for AXOOM Portal App
description: This mixin creates a container for running an (usually ASP .NET Core-based) AXOOM Portal App. Injects the App's metadata into the Portal and Identity Server using environment variables.
homepage: https://tfs.inside-axoom.org/tfs/axoom/axoom/_git/Axoom.Platform.BaseAssets?_a=readme&fullScreen=true

mixin_parameters:
  - APPKEY
  - DOCKER_REGISTRY
  - VERSION
  - PORTAL_APP
  - IDENTITY_CLIENT

external_environment:
  required:
    - PUBLIC_DOMAIN
  optional:
    - PUBLIC_PROTOCOL
    - PUBLIC_SUBDOMAIN_SEPARATOR
  
exported_environment:
  PORTAL_APPS: (PORTAL_APP)
  IDENTITY_CLIENTS: (IDENTITY_CLIENT)

dependencies:
  http://assets.axoom.cloud/services/portal.xml:

mixins:
  - feed_uri: http://assets.axoom.cloud/mixins/expose-public.xml
    version: <VERSION> # Always released with in-sync versions
    parameters:
      SERVICE_NAME: (APPKEY)
      PORT: 80

compose:
  - version: '3.2'
    services:
      (APPKEY):
        image: (DOCKER_REGISTRY)/apps/(APPKEY):(VERSION)
        environment:
          LOGGING__LOGTARGETS__0__FORMAT: Gelf
          LOGGING__LOGTARGETS__0__LEVEL: ${LOG_LEVEL-Information}
          PORTAL_BASE_URI: ${PUBLIC_PROTOCOL-https}://${PUBLIC_DOMAIN}
          IDENTITY_SERVER_URI: ${PUBLIC_PROTOCOL-https}://identity${PUBLIC_SUBDOMAIN_SEPARATOR--}${PUBLIC_DOMAIN}
        deploy:
          placement:
            constraints:
              - node.labels.worker == 1
