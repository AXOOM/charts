feed_uri: http://assets.axoom.cloud/mixins/axoom-portal-app.xml
name: AXOOM Portal App Mixin
summary: runs an AXOOM Portal App
description: This mixin runs an (usually ASP .NET Core-based) AXOOM Portal App. The App's metadata is injected into the Portal and Identity Server.
homepage: https://tfs.inside-axoom.org/tfs/axoom/axoom/_git/Axoom.Platform.BaseAssets?_a=readme&fullScreen=true

mixin_parameters:
  - APPKEY
  - DOCKER_REGISTRY
  - VERSION
  - PORTAL_APP
  - IDENTITY_CLIENT

external_environment:
  optional:
    - LOG_LEVEL
    - ASPNETCORE_ENVIRONMENT
    - WORKER_ROLE
  
exported_environment:
  PORTAL_APPS: (PORTAL_APP)
  IDENTITY_CLIENTS: (IDENTITY_CLIENT)

dependencies:
  http://assets.axoom.cloud/services/portal.xml:

mixins:
  - feed_uri: http://assets.axoom.cloud/mixins/expose-public.xml
    version: <VERSION> # Always released with in-sync versions
    parameters:
      SERVICE_NAME: (APPKEY)
      PORT: 80

compose:
  - version: '3.3'
    services:
      (APPKEY):
        image: (DOCKER_REGISTRY)/apps/(APPKEY):(VERSION)
        environment:
          LOGGING__FORMAT: Gelf
          LOGGING__LOGLEVEL__DEFAULT: ${LOG_LEVEL-Information}
          ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT-Production}
          PORTAL_BASE_URI: ${PORTAL_BASE_URI}
          IDENTITY_SERVER_URI: ${IDENTITY_SERVER_URI}
        deploy:
          labels:
            axoom.instance.publicdomain: $PUBLIC_DOMAIN # Used as human-readable instance name
            # Not using Expose Metrics Mixin, because Monitoring is also possible via the 'traefik_public' network instead of 'monitoring'
            axoom.monitoring.enable: 'true'
            axoom.monitoring.port: '5000'
            axoom.monitoring.job: '(APPKEY)'
            axoom.monitoring.network: traefik_public
          placement:
            constraints:
              - node.role == ${WORKER_ROLE:-worker}
          resources:
            limits:
              cpus: '1'
              memory: 1G
