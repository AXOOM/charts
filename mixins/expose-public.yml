feed_uri: http://assets.axoom.cloud/mixins/expose-public.xml
name: Expose Public HTTP(S) Mixin
summary: expose service to public HTTP(S) traffic
description: This mixin exposes a service to public HTTP(S) traffic.
homepage: https://tfs.inside-axoom.org/tfs/axoom/axoom/_git/Axoom.Platform.BaseAssets?_a=readme&fullScreen=true

mixin_parameters:
  - SERVICE_NAME
  - PORT

external_environment:
  required:
    - PUBLIC_DOMAIN
  optional:
    - PUBLIC_PROTOCOL

dependencies:
  http://assets.axoom.cloud/networks/traefik-public.xml:

compose:
  - version: '3.3'
    services:
      (SERVICE_NAME):
        environment:
          PUBLIC_URI: ${PUBLIC_PROTOCOL:-https}://(SERVICE_NAME)-${PUBLIC_DOMAIN}
        networks:
          - traefik_public
        deploy:
          endpoint_mode: dnsrr # Required to support large number of containers in 'traefik_public' network
          labels:
            traefik.enable: 'true'
            traefik.tags: public
            traefik.docker.network: traefik_public
            traefik.frontend.rule: Host:(SERVICE_NAME)-${PUBLIC_DOMAIN}
            traefik.port: '(PORT)'
            traefik.frontend.headers.forceSTSHeader: 'true'
            traefik.frontend.headers.STSSeconds: '315360000'
            traefik.frontend.headers.STSPreload: 'true'
            traefik.frontend.headers.STSIncludeSubdomains: 'true'
            traefik.frontend.headers.browserXSSFilter: 'true'
            traefik.frontend.headers.contentTypeNosniff: 'true'
            traefik.frontend.headers.customFrameOptionsValue: 'DENY'
            traefik.frontend.headers.contentSecurityPolicy: "frame-ancestors 'none'"
